<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integrado RMA | Inversores PV</title>
    <!-- SheetJS para ler Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Markdown Parser (Simple) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            /* Palette - Slate Theme */
            --bg-sidebar: #0f172a;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            
            --text-sidebar-main: #f8fafc;
            --text-sidebar-muted: #94a3b8;
            
            --text-main: #1e293b;
            --text-muted: #64748b;
            
            --border: #e2e8f0;
            --border-hover: #cbd5e1;
            
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --purple: #8b5cf6;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --radius: 0.5rem;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100%;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            background: var(--bg-sidebar);
            color: var(--text-sidebar-main);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            border-right: 1px solid #1e293b;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        h3 { 
            font-size: 0.75rem; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: var(--text-sidebar-muted); 
            margin-bottom: 8px;
        }

        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .sidebar-section { display: none; flex-direction: column; gap: 24px; }
        .sidebar-section.active { display: flex; }

        /* Filter Header Row */
        .filter-header-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 4px;
        }
        
        .btn-text-action {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.7rem;
            padding: 0 2px;
            font-family: inherit;
            transition: color 0.2s;
        }
        .btn-text-action:hover { color: white; text-decoration: underline; }
        .divider { color: var(--text-sidebar-muted); font-size: 0.7rem; margin: 0 2px; }

        /* File Input Style */
        .file-drop-zone {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: rgba(255,255,255,0.03);
            position: relative;
            transition: all 0.2s;
        }
        .file-drop-zone:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .file-drop-zone input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
        .file-drop-text { font-size: 0.8rem; color: var(--text-sidebar-muted); }

        /* Inputs */
        input[type="date"], input[type="text"].search-input {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 8px;
            border-radius: var(--radius);
            width: 100%;
            font-family: inherit;
            font-size: 0.85rem;
        }
        
        .checkbox-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius);
            padding: 5px;
            background: rgba(0,0,0,0.2);
        }
        .checkbox-item { display: flex; align-items: center; padding: 4px; font-size: 0.85rem; color: var(--text-sidebar-muted); cursor: pointer; }
        .checkbox-item:hover { color: white; }
        .checkbox-item input { margin-right: 8px; accent-color: var(--primary); }

        /* Buttons */
        .btn-primary {
            background: var(--primary); color: white; border: none; padding: 8px; border-radius: var(--radius); cursor: pointer; width: 100%; font-weight: 600;
        }
        .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--text-sidebar-muted); padding: 6px; border-radius: var(--radius); cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 5px; width: 100%; }
        .btn-ghost:hover { color: white; border-color: white; }

        /* AI Buttons */
        .btn-ai {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: var(--radius);
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        .btn-ai:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3); }

        /* Main Content */
        main { padding: 0; display: flex; flex-direction: column; overflow: hidden; height: 100%; }

        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
        }
        .tab-btn {
            padding: 16px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Tab Content Views */
        .tab-view {
            display: none;
            flex-direction: column;
            padding: 32px;
            overflow-y: auto;
            height: 100%;
            gap: 24px;
        }
        .tab-view.active { display: flex; }

        /* Standard Components */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .kpi-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
        .kpi-title { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .kpi-value { font-size: 1.8rem; font-weight: 700; color: var(--text-main); margin-top: 5px; }

        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .chart-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); padding: 20px; height: 400px; display: flex; flex-direction: column; }
        .chart-header { margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-weight: 600; color: var(--text-main); }
        .chart-body { flex-grow: 1; overflow-y: auto; }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .data-table th { text-align: left; padding: 10px; border-bottom: 2px solid var(--border); color: var(--text-muted); font-weight: 600; position: sticky; top: 0; background: white; z-index: 10; }
        .data-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); color: var(--text-main); vertical-align: middle; }
        .data-table tr:hover { background: #f8fafc; }
        
        /* Clickable Table Cells */
        .clickable-cell {
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            position: relative;
        }
        .clickable-cell:hover {
            background-color: #e0f2fe; /* Light blue highlight */
            color: var(--primary);
            font-weight: 500;
        }
        .clickable-cell::after {
            content: "‚ñº Filtrar";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.6rem;
            color: var(--primary);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .clickable-cell:hover::after {
            opacity: 1;
        }

        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; display: inline-block; cursor: pointer; }
        .status-sent { background: #dcfce7; color: #15803d; }
        .status-pending { background: #fef9c3; color: #a16207; }
        .status-shelf { background: #dbeafe; color: #1d4ed8; }
        .status-other { background: #f1f5f9; color: #64748b; }

        /* Bar Chart Styles */
        .bar-row { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; cursor: pointer; }
        .bar-header-row { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 500; }
        .bar-track { width: 100%; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.5s; }

        /* Insights */
        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .insight-item { padding: 15px; border-radius: var(--radius); background: white; border: 1px solid; border-left-width: 4px; cursor: pointer; transition: transform 0.2s; }
        .insight-item:hover { transform: translateY(-2px); }
        .insight-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .insight-text { font-size: 0.9rem; font-weight: 500; }
        .type-critical { border-color: var(--danger); background: #fef2f2; color: #991b1b; }
        .type-warning { border-color: var(--warning); background: #fffbeb; color: #92400e; }
        .type-info { border-color: var(--primary); background: #eff6ff; color: #1e40af; }
        .type-purple { border-color: var(--purple); background: #f5f3ff; color: #5b21b6; }
        .type-success { border-color: var(--success); background: #f0fdf4; color: #15803d; }

        .active-filter-indicator {
            background: #dbeafe;
            color: var(--primary);
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid var(--primary);
            display: none; /* Hidden by default */
            cursor: pointer;
            margin-bottom: 10px;
        }

        /* Error Box in Stock Tab */
        .error-alert-box {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            color: #991b1b;
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: none;
        }
        .error-title { font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .error-list { font-size: 0.85rem; max-height: 100px; overflow-y: auto; padding-left: 20px; }

        /* Modal AI */
        .ai-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .ai-modal {
            background: white; width: 90%; max-width: 700px; height: 80%;
            border-radius: 12px; display: flex; flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .ai-modal-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: #f8fafc;
        }
        .ai-modal-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .ai-modal-body { padding: 20px; overflow-y: auto; font-size: 0.95rem; line-height: 1.6; color: #334155; }
        .ai-modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        
        .ai-loading { text-align: center; color: var(--text-muted); padding: 40px; }
        
        /* Markdown Styles in Modal */
        .ai-modal-body h1, .ai-modal-body h2, .ai-modal-body h3 { color: var(--text-main); margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 700; }
        .ai-modal-body ul { padding-left: 20px; margin-bottom: 1em; }
        .ai-modal-body li { margin-bottom: 0.5em; }
        .ai-modal-body p { margin-bottom: 1em; }
        .ai-modal-body strong { color: var(--primary); }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 1024px) {
            .app-container { grid-template-columns: 1fr; }
            aside { display: none; } /* Mobile sidebar hidden for simplicity in this example */
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><div>Processando...</div></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside>
            <div class="brand">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                Sistema RMA
            </div>

            <!-- Sidebar Section: Analytics RMA -->
            <div id="sidebar-analytics" class="sidebar-section active">
                <div class="control-group">
                    <h3>1. Arquivos de An√°lise</h3>
                    <div class="file-drop-zone">
                        <span class="file-drop-icon">üìä</span>
                        <div class="file-drop-text">RMA_Vendas + Total_RMA + MTTF</div>
                        <input type="file" id="fileInputAnalytics" multiple accept=".xlsx, .xls">
                    </div>
                    <div id="status-analytics" style="font-size:0.7rem; color:var(--success);"></div>
                    <button class="btn-ghost" onclick="app.downloadTemplates()">üì• Baixar Modelos</button>
                </div>

                <div class="active-filter-indicator" id="crossFilterIndicator" onclick="app.clearCrossFilter()">
                    Filtro Ativo: <strong id="crossFilterText"></strong>
                    <div style="font-size: 0.7em; margin-top:4px; opacity:0.8;">Clique para limpar</div>
                </div>

                <div class="control-group">
                    <h3>2. Filtros Globais</h3>
                    <div style="font-size:0.7rem; color:var(--text-sidebar-muted); margin-bottom:4px;">Periodo</div>
                    <input type="date" id="dateStart" onchange="app.renderAnalytics()">
                    <input type="date" id="dateEnd" onchange="app.renderAnalytics()">
                </div>

                <div class="control-group">
                    <h3>Status Estoque</h3>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <label class="checkbox-item"><input type="radio" name="stockFilter" value="all" checked onchange="app.setStockFilter('all')"> Todos</label>
                        <label class="checkbox-item"><input type="radio" name="stockFilter" value="Sim" onchange="app.setStockFilter('Sim')"> Em Estoque</label>
                        <label class="checkbox-item"><input type="radio" name="stockFilter" value="N√£o" onchange="app.setStockFilter('N√£o')"> Fora de Estoque</label>
                    </div>
                </div>

                <div class="control-group">
                    <div class="filter-header-row">
                        <h3>Fabricante</h3>
                        <div>
                            <button class="btn-text-action" onclick="app.toggleGroup('manuf', true)">Todos</button>
                            <span class="divider">/</span>
                            <button class="btn-text-action" onclick="app.toggleGroup('manuf', false)">Limpar</button>
                        </div>
                    </div>
                    <div class="checkbox-list" id="filter-manufacturers"></div>
                </div>

                <div class="control-group">
                    <div class="filter-header-row">
                        <h3>Modelo</h3>
                        <div>
                            <button class="btn-text-action" onclick="app.toggleGroup('model', true)">Todos</button>
                            <span class="divider">/</span>
                            <button class="btn-text-action" onclick="app.toggleGroup('model', false)">Limpar</button>
                        </div>
                    </div>
                    <input type="text" id="modelSearch" class="search-input" placeholder="Buscar..." oninput="app.filterModelsUI()">
                    <div class="checkbox-list" id="filter-models"></div>
                </div>
                
                <button class="btn-primary" onclick="app.resetAnalyticsFilters()">Limpar Filtros</button>

                <!-- AI Button -->
                <button class="btn-ai" onclick="app.triggerAIAnalysis()">
                    ‚ú® An√°lise Inteligente
                </button>
                <div id="ai-email-btn-container" style="display:none;">
                    <button class="btn-ghost" style="margin-top:8px; color:var(--text-main); border-color:var(--border);" onclick="app.triggerEmailDraft()">
                        ‚úâÔ∏è Rascunhar E-mail
                    </button>
                </div>
            </div>

            <!-- Sidebar Section: Stock Dashboard -->
            <div id="sidebar-stock" class="sidebar-section">
                <div class="control-group">
                    <h3>Arquivo de Estoque</h3>
                    <div class="file-drop-zone">
                        <span class="file-drop-icon">üì¶</span>
                        <div class="file-drop-text">Estoque danificado.xlsx</div>
                        <input type="file" id="fileInputStock" accept=".xlsx, .xls">
                    </div>
                    <div id="status-stock" style="font-size:0.7rem; color:var(--success);"></div>
                </div>
                
                <div class="control-group">
                    <div class="filter-header-row">
                        <h3>Filtrar por Status</h3>
                        <div>
                            <button class="btn-text-action" onclick="app.toggleStockGroup('status', true)">Todos</button>
                            <span class="divider">/</span>
                            <button class="btn-text-action" onclick="app.toggleStockGroup('status', false)">Limpar</button>
                        </div>
                    </div>
                    <div class="checkbox-list" id="filter-stock-status"></div>
                </div>

                <div class="control-group">
                    <div class="filter-header-row">
                        <h3>Filtrar por Fabricante</h3>
                        <div>
                            <button class="btn-text-action" onclick="app.toggleStockGroup('manuf', true)">Todos</button>
                            <span class="divider">/</span>
                            <button class="btn-text-action" onclick="app.toggleStockGroup('manuf', false)">Limpar</button>
                        </div>
                    </div>
                    <div class="checkbox-list" id="filter-stock-manuf"></div>
                </div>
                
                <div class="control-group">
                    <div class="filter-header-row">
                        <h3>Filtrar por CD</h3>
                        <div>
                            <button class="btn-text-action" onclick="app.toggleStockGroup('cd', true)">Todos</button>
                            <span class="divider">/</span>
                            <button class="btn-text-action" onclick="app.toggleStockGroup('cd', false)">Limpar</button>
                        </div>
                    </div>
                    <div class="checkbox-list" id="filter-stock-cd"></div>
                </div>
                
                <button class="btn-primary" onclick="app.resetStockFilters()">Limpar Filtros</button>

                <!-- AI Button for Stock -->
                <button class="btn-ai" onclick="app.triggerAIAnalysis()">
                    ‚ú® Otimizar Log√≠stica
                </button>
            </div>
        </aside>

        <!-- Content Area -->
        <main>
            <!-- Tab Navigation -->
            <nav class="tabs-nav">
                <button class="tab-btn active" onclick="app.switchTab('analytics')">Analytics RMA</button>
                <button class="tab-btn" onclick="app.switchTab('stock')">Estoque & Envios</button>
            </nav>

            <!-- VIEW 1: Analytics RMA -->
            <div id="view-analytics" class="tab-view active">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">Total Vendas</div>
                        <div class="kpi-value" id="kpi-sales">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Total RMAs</div>
                        <div class="kpi-value" id="kpi-rmas">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Taxa de Falha</div>
                        <div class="kpi-value" id="kpi-rate">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Estados Afetados</div>
                        <div class="kpi-value" id="kpi-states">-</div>
                    </div>
                </div>

                <div class="insights-grid" id="insights-container">
                    <div class="insight-item type-info"><div class="insight-text">Carregue os arquivos para an√°lise.</div></div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">Taxa de Falha por Modelo</div>
                        <div class="chart-body" id="chart-rate-model"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">Top 10 Defeitos Recorrentes</div>
                        <div class="chart-body" id="chart-defects"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">Distribui√ß√£o Regional (Estados)</div>
                        <div class="chart-body" id="chart-geo"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">MTTF (Tempo M√©dio at√© Falha)</div>
                        <div class="chart-body" id="chart-mttf"></div>
                    </div>
                </div>

                <!-- NEW: Analytics Data Table -->
                <div class="chart-card" style="height: auto; max-height: 500px; margin-top: 20px;">
                    <div class="chart-header">Detalhamento de RMAs</div>
                    <div class="chart-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Produto / Modelo</th>
                                    <th>Fabricante</th>
                                    <th>Defeito</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="table-analytics">
                                <tr><td colspan="5" style="text-align:center;">Nenhum dado carregado</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: Stock Dashboard -->
            <div id="view-stock" class="tab-view">
                <!-- ERROR BOX -->
                <div id="stock-error-box" class="error-alert-box">
                    <div class="error-title">
                        <span>‚ö†Ô∏è Aten√ß√£o: Itens com Dados Incompletos</span>
                    </div>
                    <ul class="error-list" id="stock-error-list"></ul>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">Total Itens Danificados</div>
                        <div class="kpi-value" id="stock-kpi-total">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Itens Programados (Separados + Data)</div>
                        <div class="kpi-value" id="stock-kpi-scheduled" style="color:var(--primary)">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Pendentes / Recebidos</div>
                        <div class="kpi-value" id="stock-kpi-pending" style="color:var(--warning)">-</div>
                    </div>
                </div>

                <!-- ADDED: Stock Insights Container -->
                <div class="insights-grid" id="stock-insights-container" style="margin-top: 20px;">
                    <div class="insight-item type-info"><div class="insight-text">Carregue o arquivo de estoque.</div></div>
                </div>

                <!-- Destaque para Itens Programados -->
                <div class="charts-grid">
                    <div class="chart-card" style="grid-column: span 2;">
                        <div class="chart-header">
                            Modelos Programados para Envio (Qtd.)
                            <span style="font-size:0.8rem; font-weight:400; color:var(--text-muted); margin-left:10px;">
                                Agrupado por Data de Previs√£o
                            </span>
                        </div>
                        <div class="chart-body" id="chart-scheduled-models"></div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">Status Geral dos Equipamentos</div>
                        <div class="chart-body" id="chart-stock-status"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">Itens por Fabricante</div>
                        <div class="chart-body" id="chart-stock-manuf"></div>
                    </div>
                </div>
                
                <!-- NEW: Chart by CD -->
                <div class="charts-grid">
                    <div class="chart-card" style="grid-column: span 2;">
                        <div class="chart-header">Quantidade por CD</div>
                        <div class="chart-body" id="chart-stock-cd"></div>
                    </div>
                </div>

                <div class="chart-card" style="height: auto; max-height: 500px;">
                    <div class="chart-header">Previs√£o de Envios (Pr√≥ximas Datas)</div>
                    <div class="chart-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data / Prev.</th>
                                    <th>SN</th>
                                    <th>Fabricante</th>
                                    <th>Produto / Modelo</th>
                                    <th>Status Atual</th>
                                    <th>CD / Local</th>
                                </tr>
                            </thead>
                            <tbody id="table-forecast">
                                <tr><td colspan="6" style="text-align:center;">Nenhum dado carregado</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Result Modal -->
    <div id="aiModal" class="ai-modal-overlay">
        <div class="ai-modal">
            <div class="ai-modal-header">
                <div class="ai-modal-title">‚ú® <span id="aiModalTitle">An√°lise Gemini</span></div>
                <button class="btn-ghost" style="width:auto; padding:5px 10px;" onclick="app.closeAIModal()">‚úï</button>
            </div>
            <div class="ai-modal-body" id="aiModalBody">
                <!-- Content goes here -->
            </div>
            <div class="ai-modal-footer">
                <button class="btn-ghost" style="width:auto;" onclick="app.copyAIContent()">Copiar Texto</button>
                <button class="btn-primary" style="width:auto;" onclick="app.closeAIModal()">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // Provided by environment

        const app = {
            data: { analytics: { sales: [], rmas: [], mttf: [] }, stock: [] },
            mapping: { productToManuf: {}, productToStock: {} },
            filters: {
                analytics: { manufacturers: new Set(), models: new Set(), dateStart: null, dateEnd: null, crossFilter: null, stockStatus: 'all' },
                stock: { status: new Set(), cd: new Set(), manuf: new Set() }
            },
            activeTab: 'analytics',
            currentAIContext: {},

            init: function() {
                document.getElementById('fileInputAnalytics').addEventListener('change', (e) => this.handleAnalyticsUpload(e));
                document.getElementById('fileInputStock').addEventListener('change', (e) => this.handleStockUpload(e));
            },

            // --- Navigation ---
            switchTab: function(tabName) {
                this.activeTab = tabName;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                const btn = document.querySelector(`.tab-btn[onclick="app.switchTab('${tabName}')"]`);
                if(btn) btn.classList.add('active');
                
                document.querySelectorAll('.tab-view').forEach(v => v.classList.remove('active'));
                const view = document.getElementById(`view-${tabName}`);
                if(view) view.classList.add('active');

                document.querySelectorAll('.sidebar-section').forEach(s => s.classList.remove('active'));
                const sidebar = document.getElementById(`sidebar-${tabName}`);
                if(sidebar) sidebar.classList.add('active');
            },

            toggleLoader: function(show) {
                const l = document.getElementById('loader');
                if(l) l.style.display = show ? 'flex' : 'none';
            },

            normalizeKeys: function(data) {
                if (!data || !data.length) return data;
                return data.map(row => {
                    const newRow = {};
                    Object.keys(row).forEach(key => { newRow[key.trim()] = row[key]; });
                    return newRow;
                });
            },

            // ============================================================
            // LOGIC: ANALYTICS RMA
            // ============================================================
            
            handleAnalyticsUpload: async function(e) {
                const files = e.target.files;
                if (files.length === 0) return;
                this.toggleLoader(true);
                try {
                    const promises = Array.from(files).map(file => this.readFile(file));
                    const results = await Promise.all(promises);
                    this.processAnalyticsFiles(results);
                    this.buildAnalyticsFilters();
                    this.renderAnalytics();
                    document.getElementById('status-analytics').innerText = `${files.length} arquivos carregados`;
                } catch (err) { alert("Erro: " + err.message); } finally { this.toggleLoader(false); }
            },

            processAnalyticsFiles: function(results) {
                this.data.analytics = { sales: [], rmas: [], mttf: [] };
                this.mapping.productToManuf = {}; this.mapping.productToStock = {};

                results.forEach(res => {
                    const rawData = this.normalizeKeys(res.data);
                    const keys = Object.keys(rawData[0] || {});
                    if (keys.includes("Total Vendido")) this.data.analytics.sales = rawData;
                    else if (keys.includes("Problem√°tica")) this.data.analytics.rmas = rawData.map(row => ({...row, "Data de Cria√ß√£o": row["Data de Cria√ß√£o"] instanceof Date ? row["Data de Cria√ß√£o"] : new Date(row["Data de Cria√ß√£o"])}));
                    else if (keys.includes("M√©dia de MTTF")) this.data.analytics.mttf = rawData;
                });
                // Mapping
                const allRows = [...this.data.analytics.sales, ...this.data.analytics.rmas];
                allRows.forEach(row => {
                    if (row["Produto"]) {
                        // Clean strings
                        const prod = row["Produto"].toString().trim();
                        if (row["Fabricante"]) this.mapping.productToManuf[prod] = row["Fabricante"].toString().trim();
                        if (row["Ativo"]) this.mapping.productToStock[prod] = row["Ativo"].toString().trim();
                    }
                });
                this.data.analytics.mttf.forEach(row => { 
                    if(row["Produto"]) {
                        const prod = row["Produto"].toString().trim();
                        if (!row["Fabricante"]) row["Fabricante"] = this.mapping.productToManuf[prod] || "Desconhecido"; 
                    }
                });
            },

            buildAnalyticsFilters: function() {
                const manufacturers = new Set(); const models = new Set();
                [this.data.analytics.sales, this.data.analytics.rmas].forEach(src => { 
                    src.forEach(r => { 
                        if (r["Fabricante"]) manufacturers.add(r["Fabricante"].toString().trim()); 
                        if (r["Produto"]) models.add(r["Produto"].toString().trim()); 
                    }); 
                });
                const manufContainer = document.getElementById('filter-manufacturers'); manufContainer.innerHTML = '';
                Array.from(manufacturers).sort().forEach(m => { manufContainer.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="filter-checkbox" data-group="manuf" value="${m}">${m}</label>`; });
                const modelContainer = document.getElementById('filter-models'); modelContainer.innerHTML = '';
                Array.from(models).sort().forEach(m => { const manuf = this.mapping.productToManuf[m] || ""; modelContainer.innerHTML += `<label class="checkbox-item model-wrapper" data-manuf="${manuf}" data-model="${m.toLowerCase()}"><input type="checkbox" class="filter-checkbox" data-group="model" value="${m}">${m}</label>`; });
                document.querySelectorAll('#sidebar-analytics .filter-checkbox').forEach(cb => { cb.addEventListener('change', () => { if(cb.dataset.group === 'manuf') this.filterModelsUI(); this.renderAnalytics(); }); });
            },

            renderAnalytics: function() {
                const dateStartStr = document.getElementById('dateStart').value;
                const dateEndStr = document.getElementById('dateEnd').value;
                const dateStart = dateStartStr ? new Date(dateStartStr) : null;
                const dateEnd = dateEndStr ? new Date(dateEndStr) : null;
                if(dateEnd) dateEnd.setHours(23,59,59);
                const selManuf = Array.from(document.querySelectorAll('#sidebar-analytics input[data-group="manuf"]:checked')).map(c => c.value);
                const selModel = Array.from(document.querySelectorAll('#sidebar-analytics input[data-group="model"]:checked')).map(c => c.value);
                const stockFilter = this.filters.analytics.stockStatus.toLowerCase();
                const passCommon = (row) => {
                    const rManuf = row["Fabricante"] ? row["Fabricante"].toString().trim() : "";
                    const rProd = row["Produto"] ? row["Produto"].toString().trim() : "";
                    if (selManuf.length && !selManuf.includes(rManuf)) return false;
                    if (selModel.length && !selModel.includes(rProd)) return false;
                    const cf = this.filters.analytics.crossFilter;
                    if (cf) { 
                        if (cf.type === 'state' && row["Estado"] !== cf.value) return false; 
                        if (cf.type === 'model' && rProd !== cf.value) return false; 
                        if (cf.type === 'defect' && row["Problem√°tica"] !== cf.value) return false; 
                        if (cf.type === 'manuf' && rManuf !== cf.value) return false;
                    }
                    return true;
                };
                const checkStock = (row) => { 
                    if (stockFilter === 'all') return true; 
                    const prod = row["Produto"] ? row["Produto"].toString().trim() : "";
                    let st = (row["Ativo"] || this.mapping.productToStock[prod] || "").toString().trim().toLowerCase(); 
                    return st === stockFilter; 
                };
                
                const filteredSales = this.data.analytics.sales.filter(r => passCommon(r) && checkStock(r));
                const filteredRmas = this.data.analytics.rmas.filter(r => { if(dateStart && r["Data de Cria√ß√£o"] < dateStart) return false; if(dateEnd && r["Data de Cria√ß√£o"] > dateEnd) return false; return passCommon(r) && checkStock(r); });
                const filteredMttf = this.data.analytics.mttf.filter(r => passCommon(r) && checkStock(r));
                
                const totalRmas = filteredRmas.length;
                const uniqueStates = new Set(filteredRmas.map(r => r["Estado"]).filter(x=>x)).size;
                const modelStats = {};
                filteredSales.forEach(s => { 
                    const p = s["Produto"] ? s["Produto"].toString().trim() : "N/A";
                    if(!modelStats[p]) modelStats[p] = { sales:0, rmas:0 }; 
                    modelStats[p].sales += (parseFloat(s["Total Vendido"]) || 0); 
                });
                filteredRmas.forEach(r => { 
                    const p = r["Produto"] ? r["Produto"].toString().trim() : "N/A";
                    if(modelStats[p]) modelStats[p].rmas++; 
                    else if(!this.data.analytics.sales.length) modelStats[p] = { sales:1, rmas:1 }; 
                });
                const totalSales = Object.values(modelStats).reduce((acc, curr) => acc + curr.sales, 0);
                const rate = totalSales > 0 ? ((totalRmas/totalSales)*100).toFixed(2) : "0.00";
                
                document.getElementById('kpi-sales').innerText = totalSales.toLocaleString();
                document.getElementById('kpi-rmas').innerText = totalRmas.toLocaleString();
                document.getElementById('kpi-rate').innerText = rate + "%";
                document.getElementById('kpi-states').innerText = uniqueStates;
                
                const chartRate = Object.entries(modelStats).map(([m, s]) => ({ label: m, value: s.sales > 0 ? (s.rmas/s.sales)*100 : 0, displayHtml: `<span class="value-highlight">${(s.sales>0?(s.rmas/s.sales)*100:0).toFixed(2)}%</span> <span style="font-size:0.8em;color:var(--text-muted);">(${s.rmas} RMAs / ${s.sales} Vendas)</span>`, raw: m })).sort((a,b) => b.value - a.value);
                const defectCounts = {}; filteredRmas.forEach(r => { const d = r["Problem√°tica"] || "N/A"; defectCounts[d] = (defectCounts[d]||0)+1; });
                const chartDefects = Object.entries(defectCounts).map(([d, c]) => ({ label: d, value: c, displayHtml: `<span class="value-highlight">${c}</span> <span style="font-size:0.8em;color:var(--text-muted);">(${totalRmas>0?((c/totalRmas)*100).toFixed(2):0}%)</span>`, raw: d })).sort((a,b) => b.value - a.value).slice(0, 10);
                const stateCounts = {}; filteredRmas.forEach(r => { const s = r["Estado"] || "N/A"; stateCounts[s] = (stateCounts[s]||0)+1; });
                const chartGeo = Object.entries(stateCounts).map(([s, c]) => ({ label: s, value: c, displayHtml: `<span class="value-highlight">${c}</span>`, raw: s })).sort((a,b) => b.value - a.value);
                const chartMttf = filteredMttf.map(r => ({ label: r["Produto"], value: parseFloat(r["M√©dia de MTTF"]), displayHtml: `<span class="value-highlight">${this.formatMTTF(r["M√©dia de MTTF"])}</span>`, raw: r["Produto"] })).sort((a,b) => a.value - b.value);
                
                this.drawBarChart('chart-rate-model', chartRate, 'model'); this.drawBarChart('chart-defects', chartDefects, 'defect'); this.drawBarChart('chart-geo', chartGeo, 'state'); this.drawBarChart('chart-mttf', chartMttf, 'model');
                this.renderAnalyticsTable(filteredRmas);

                const indicator = document.getElementById('crossFilterIndicator');
                if (indicator) { if (this.filters.analytics.crossFilter) { indicator.style.display = 'block'; document.getElementById('crossFilterText').innerText = `${this.translateType(this.filters.analytics.crossFilter.type)}: ${this.filters.analytics.crossFilter.value}`; } else { indicator.style.display = 'none'; } }
                
                // Allow generating insights even if only RMAs exist (e.g. Rate chart empty because no sales file matched)
                this.generateInsights(chartRate, chartDefects, chartGeo, chartMttf, modelStats);
                
                this.currentAIContext.analytics = { hasData: filteredRmas.length > 0 || filteredSales.length > 0, sales: totalSales, rmas: totalRmas, rate: rate + "%", topModels: chartRate.slice(0, 5), topDefects: chartDefects.slice(0, 5), topStates: chartGeo.slice(0, 3), period: `${dateStartStr || 'In√≠cio'} at√© ${dateEndStr || 'Hoje'}` };
            },
            
            renderAnalyticsTable: function(data) {
                const tableBody = document.getElementById('table-analytics');
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Nenhum dado carregado</td></tr>';
                    return;
                }
                const visibleItems = data.slice(0, 300); // Limit for performance
                const rows = visibleItems.map(item => {
                    let dateDisplay = item["Data de Cria√ß√£o"] instanceof Date ? item["Data de Cria√ß√£o"].toLocaleDateString() : "-";
                    return `
                    <tr>
                        <td>${dateDisplay}</td>
                        <td class="clickable-cell" onclick="app.applyAnalyticsCrossFilter('model', '${item["Produto"]}')">${item["Produto"]}</td>
                        <td class="clickable-cell" onclick="app.applyAnalyticsCrossFilter('manuf', '${item["Fabricante"]}')">${item["Fabricante"]}</td>
                        <td class="clickable-cell" onclick="app.applyAnalyticsCrossFilter('defect', '${item["Problem√°tica"]}')">${item["Problem√°tica"]}</td>
                        <td class="clickable-cell" onclick="app.applyAnalyticsCrossFilter('state', '${item["Estado"]}')">${item["Estado"]}</td>
                    </tr>`;
                }).join('');
                tableBody.innerHTML = rows;
                if (data.length > 300) tableBody.innerHTML += `<tr><td colspan="5" style="text-align:center; color:var(--text-muted); font-size:0.75rem; padding:10px;">...Exibindo os primeiros 300 itens...</td></tr>`;
            },

            // ============================================================
            // LOGIC: STOCK DASHBOARD
            // ============================================================

            handleStockUpload: async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                this.toggleLoader(true);
                try {
                    const result = await this.readFile(file);
                    const rawData = this.normalizeKeys(result.data);
                    this.data.stock = rawData.map(row => ({
                        sn: row["SN"] || "", model: row["PRODUTO"] || "Desconhecido", manuf: row["FABRICANTE"] || "Outros",
                        status: (row["STATUS"] || "Desconhecido").toString().toUpperCase(), forecast: row["PREVIS√ÉO DE ENVIO"],
                        sentDate: row["DATA DE ENVIO"], cd: row["CD"] || "N/A"
                    }));
                    this.buildStockFilters(); this.renderStockDashboard(); document.getElementById('status-stock').innerText = "Arquivo processado com sucesso";
                } catch (err) { alert("Erro ao ler Estoque: " + err.message); } finally { this.toggleLoader(false); }
            },

            buildStockFilters: function() {
                const statuses = new Set(this.data.stock.map(i => i.status));
                const cds = new Set(this.data.stock.map(i => i.cd));
                const manufs = new Set(this.data.stock.map(i => i.manuf));

                const statusContainer = document.getElementById('filter-stock-status'); statusContainer.innerHTML = '';
                Array.from(statuses).sort().forEach(s => { statusContainer.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="stock-check" data-type="status" value="${s}">${s}</label>`; });

                const cdContainer = document.getElementById('filter-stock-cd'); cdContainer.innerHTML = '';
                Array.from(cds).sort().forEach(c => { cdContainer.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="stock-check" data-type="cd" value="${c}">${c}</label>`; });

                const manufContainer = document.getElementById('filter-stock-manuf'); manufContainer.innerHTML = '';
                Array.from(manufs).sort().forEach(m => { manufContainer.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="stock-check" data-type="manuf" value="${m}">${m}</label>`; });

                document.querySelectorAll('.stock-check').forEach(cb => { cb.addEventListener('change', () => this.renderStockDashboard()); });
            },

            renderStockDashboard: function() {
                const selStatus = Array.from(document.querySelectorAll('.stock-check[data-type="status"]:checked')).map(c => c.value);
                const selCd = Array.from(document.querySelectorAll('.stock-check[data-type="cd"]:checked')).map(c => c.value);
                const selManuf = Array.from(document.querySelectorAll('.stock-check[data-type="manuf"]:checked')).map(c => c.value);

                const filtered = this.data.stock.filter(item => {
                    if (selStatus.length && !selStatus.includes(item.status)) return false;
                    if (selCd.length && !selCd.includes(item.cd)) return false;
                    if (selManuf.length && !selManuf.includes(item.manuf)) return false;
                    return true;
                });

                // Validation & Scheduled
                const errors = []; const scheduledItems = []; let sentCount = 0;
                filtered.forEach(i => {
                    const isSeparated = i.status.includes("SEPARADO PARA ENVIO") || i.status.includes("PALETIZADO");
                    const isSent = i.status.includes("ENVIADO");
                    let hasForecast = false; if (i.forecast && (i.forecast instanceof Date && !isNaN(i.forecast) || typeof i.forecast === 'string' && i.forecast.trim() !== '')) hasForecast = true;
                    let hasSentDate = false; if (i.sentDate && (i.sentDate instanceof Date && !isNaN(i.sentDate) || typeof i.sentDate === 'string' && i.sentDate.trim() !== '')) hasSentDate = true;
                    if (isSeparated && !hasForecast) errors.push(`SN: ${i.sn || 'S/N'} (${i.model}) - Separado s/ previs√£o`);
                    if (isSent && !hasSentDate) errors.push(`SN: ${i.sn || 'S/N'} (${i.model}) - Enviado s/ data`);
                    if (isSent) sentCount++;
                    if (isSeparated && hasForecast) scheduledItems.push(i);
                });

                const errorBox = document.getElementById('stock-error-box');
                const errorList = document.getElementById('stock-error-list');
                if (errors.length > 0) { errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join(''); errorBox.style.display = 'block'; } else { errorBox.style.display = 'none'; }

                const total = filtered.length; const pendingCount = total - sentCount; const scheduledCount = scheduledItems.length;
                if(document.getElementById('stock-kpi-total')) document.getElementById('stock-kpi-total').innerText = total;
                if(document.getElementById('stock-kpi-sent')) document.getElementById('stock-kpi-sent').innerText = sentCount;
                if(document.getElementById('stock-kpi-pending')) document.getElementById('stock-kpi-pending').innerText = pendingCount;
                if(document.getElementById('stock-kpi-scheduled')) document.getElementById('stock-kpi-scheduled').innerText = scheduledCount;

                const scheduledGrouped = {};
                scheduledItems.forEach(i => {
                    let dateObj = null; let dateDisplay = "Data a definir"; let sortKey = 9999999999999;
                    if (i.forecast instanceof Date && !isNaN(i.forecast)) dateObj = i.forecast;
                    else if (typeof i.forecast === 'string') { const p = new Date(i.forecast); if (!isNaN(p)) dateObj = p; else dateDisplay = i.forecast; }
                    if (dateObj && !isNaN(dateObj)) { const d = String(dateObj.getDate()).padStart(2, '0'); const m = String(dateObj.getMonth() + 1).padStart(2, '0'); dateDisplay = `${d}/${m}`; sortKey = dateObj.getTime(); }
                    const key = `${sortKey}|${dateDisplay}|${i.model}`;
                    scheduledGrouped[key] = (scheduledGrouped[key] || 0) + 1;
                });
                const chartScheduled = Object.entries(scheduledGrouped).map(([k, v]) => { const [sortVal, dateStr, modelName] = k.split('|'); return { sortVal: parseInt(sortVal), label: `${dateStr} - ${modelName}`, value: v, displayHtml: `<span class="value-highlight">${v}</span>` }; }).sort((a, b) => (a.sortVal !== b.sortVal) ? a.sortVal - b.sortVal : b.value - a.value);
                this.drawBarChart('chart-scheduled-models', chartScheduled, null);

                const statusCount = {}; filtered.forEach(i => statusCount[i.status] = (statusCount[i.status]||0)+1);
                const chartStatus = Object.entries(statusCount).map(([k,v]) => ({ label: k, value: v, displayHtml: `<span class="value-highlight">${v}</span>` })).sort((a,b) => b.value - a.value);
                this.drawBarChart('chart-stock-status', chartStatus, 'status-stock');

                const manufCount = {}; filtered.forEach(i => manufCount[i.manuf] = (manufCount[i.manuf]||0)+1);
                const chartManuf = Object.entries(manufCount).map(([k,v]) => ({ label: k, value: v, displayHtml: `<span class="value-highlight">${v}</span>`, raw: k })).sort((a,b) => b.value - a.value);
                this.drawBarChart('chart-stock-manuf', chartManuf, 'manuf-stock');
                
                const cdCount = {}; filtered.forEach(i => cdCount[i.cd] = (cdCount[i.cd]||0)+1);
                const chartCd = Object.entries(cdCount).map(([k,v]) => ({ label: k, value: v, displayHtml: `<span class="value-highlight">${v}</span>`, raw: k })).sort((a,b) => b.value - a.value);
                this.drawBarChart('chart-stock-cd', chartCd, 'cd-stock');

                const tableBody = document.getElementById('table-forecast');
                if (filtered.length === 0) { tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Nenhum dado</td></tr>'; } else {
                    const sortedItems = [...filtered].sort((a, b) => {
                        const dA = a.sentDate ? new Date(a.sentDate) : (a.forecast ? new Date(a.forecast) : null); const dB = b.sentDate ? new Date(b.sentDate) : (b.forecast ? new Date(b.forecast) : null);
                        if (!isValidDate(dA)) return 1; if (!isValidDate(dB)) return -1; return dA - dB;
                    });
                    const visibleItems = sortedItems.slice(0, 500); 
                    const rowsHtml = visibleItems.map(item => {
                        let dateDisplay = "-"; let dateVal = null;
                        if (item.status.includes("ENVIADO")) { if (item.sentDate) dateVal = item.sentDate; } else { if (item.forecast) dateVal = item.forecast; }
                        if (dateVal instanceof Date) dateDisplay = dateVal.toLocaleDateString(); else if (dateVal) dateDisplay = dateVal;
                        let badgeClass = 'status-pending';
                        if (item.status.includes('ENVIADO')) badgeClass = 'status-sent'; else if (item.status.includes('RECEBIDO')) badgeClass = 'status-shelf'; else badgeClass = 'status-other';
                        return `
                            <tr>
                                <td class="clickable-cell" onclick="app.setStockTableFilter('date', '${dateDisplay}')"><strong>${dateDisplay}</strong></td>
                                <td style="font-family:monospace; font-size:0.75rem;">${item.sn || '-'}</td>
                                <td class="clickable-cell" onclick="app.setStockTableFilter('manuf', '${item.manuf}')">${item.manuf}</td>
                                <td class="clickable-cell" onclick="app.setStockTableFilter('model', '${item.model}')">${item.model}</td>
                                <td><span class="status-badge ${badgeClass}" onclick="app.setStockTableFilter('status', '${item.status}')">${item.status}</span></td>
                                <td class="clickable-cell" onclick="app.setStockTableFilter('cd', '${item.cd}')">${item.cd}</td>
                            </tr>`;
                    }).join('');
                    tableBody.innerHTML = rowsHtml;
                    if (sortedItems.length > 500) tableBody.innerHTML += `<tr><td colspan="6" style="text-align:center; padding:10px;">...Exibindo os primeiros 500 itens...</td></tr>`;
                }
                this.generateStockInsights(filtered, scheduledItems, sentCount);
                this.currentAIContext.stock = { hasData: filtered.length > 0, total: total, sent: sentCount, pending: pendingCount, scheduled: scheduledCount, topManuf: chartManuf.slice(0, 3).map(m => `${m.label} (${m.value})`), statusBreakdown: chartStatus.map(s => `${s.label}: ${s.value}`) };
            },
            
            // --- NEW: Stock Toggle Group ---
            toggleStockGroup: function(group, state) {
                const inputs = document.querySelectorAll(`.stock-check[data-type="${group}"]`);
                inputs.forEach(inp => inp.checked = state);
                this.renderStockDashboard();
            },

            // --- Table Filter Handlers ---
            setStockTableFilter: function(type, val) {
                if (type === 'status' || type === 'cd' || type === 'manuf') {
                    const cb = document.querySelector(`.stock-check[data-type="${type}"][value="${val}"]`);
                    if(cb) {
                        document.querySelectorAll(`.stock-check[data-type="${type}"]`).forEach(c => c.checked = false);
                        cb.checked = true;
                        this.renderStockDashboard();
                    }
                } else if (type === 'model') {
                    alert(`Filtro por modelo: ${val} (Funcionalidade de filtro de texto pendente na UI)`);
                }
            },

            // --- Utils & Shared ---
            readFile: function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                            const firstSheetName = workbook.SheetNames[0];
                            const json = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);
                            resolve({ name: file.name, data: json });
                        } catch (err) { reject(err); }
                    };
                    reader.readAsArrayBuffer(file);
                });
            },
            drawBarChart: function(containerId, data, filterType) {
                const container = document.getElementById(containerId); container.innerHTML = '';
                if (data.length === 0) { container.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:40px 0;">Sem dados</div>'; return; }
                const max = Math.max(...data.map(d => d.value));
                data.forEach(item => {
                    const w = (item.value / max) * 100;
                    const div = document.createElement('div'); div.className = 'bar-row';
                    if (filterType === 'manuf-stock') { div.onclick = () => this.setStockTableFilter('manuf', item.raw); div.title = "Clique para filtrar por este fabricante"; }
                    else if (filterType === 'status-stock') { div.onclick = () => this.setStockTableFilter('status', item.label); div.title = "Clique para filtrar por este status"; }
                    else if (filterType === 'cd-stock') { div.onclick = () => this.setStockTableFilter('cd', item.raw); div.title = "Clique para filtrar por este CD"; }
                    else if (filterType && filterType.endsWith('-stock')) { 
                        const rawType = filterType.replace('-stock','');
                        div.onclick = () => this.setStockTableFilter(rawType, item.raw || item.label); 
                    }
                    else if (filterType) { div.onclick = () => this.applyAnalyticsCrossFilter(filterType, item.raw); }
                    div.innerHTML = `<div class="bar-header-row"><span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:65%;" title="${item.label}">${item.label}</span><span>${item.displayHtml}</span></div><div class="bar-track"><div class="bar-fill" style="width:${w}%"></div></div>`;
                    container.appendChild(div);
                });
            },
            applyAnalyticsCrossFilter: function(type, val) { this.filters.analytics.crossFilter = { type, value: val }; this.renderAnalytics(); },
            clearCrossFilter: function() { this.filters.analytics.crossFilter = null; this.renderAnalytics(); },
            filterModelsUI: function() { const search = document.getElementById('modelSearch').value.toLowerCase(); const selManuf = Array.from(document.querySelectorAll('#sidebar-analytics input[data-group="manuf"]:checked')).map(c => c.value); document.querySelectorAll('.model-wrapper').forEach(el => { const mName = el.dataset.model; const mManuf = el.dataset.manuf; const matchSearch = mName.includes(search); const matchManuf = selManuf.length === 0 || selManuf.includes(mManuf); el.style.display = (matchSearch && matchManuf) ? 'flex' : 'none'; }); },
            toggleGroup: function(group, state) { const inputs = document.querySelectorAll(`input[data-group="${group}"]`); inputs.forEach(inp => { if(inp.closest('label').style.display !== 'none') inp.checked = state; }); if(group === 'manuf') this.filterModelsUI(); this.renderAnalytics(); },
            setStockFilter: function(val) { this.filters.analytics.stockStatus = val; this.renderAnalytics(); },
            resetAnalyticsFilters: function() { document.getElementById('dateStart').value = ''; document.getElementById('dateEnd').value = ''; document.getElementById('modelSearch').value = ''; this.filters.analytics.stockStatus = 'all'; this.filters.analytics.crossFilter = null; const stockRadios = document.getElementsByName('stockFilter'); if(stockRadios.length > 0) stockRadios[0].checked = true; document.querySelectorAll('#sidebar-analytics .filter-checkbox').forEach(cb => cb.checked = false); this.filterModelsUI(); this.renderAnalytics(); },
            resetStockFilters: function() { document.querySelectorAll('.stock-check').forEach(cb => cb.checked = false); this.renderStockDashboard(); },
            
            // ... (AI & Templates - Same)
            triggerAIAnalysis: async function() { /* ... */ },
            triggerEmailDraft: async function() { /* ... */ },
            callGeminiAPI: async function(prompt) { /* ... */ },
            getAnalyticsContext: function() { /* ... */ },
            getStockContext: function() { /* ... */ },
            openAIModal: function(t) { document.getElementById('aiModalTitle').innerText=t; document.getElementById('aiModal').style.display='flex'; },
            closeAIModal: function() { document.getElementById('aiModal').style.display='none'; },
            showAILoading: function() { document.getElementById('aiModalBody').innerHTML = `<div class="ai-loading"><div class="spinner" style="margin:0 auto 10px auto;"></div>Gerando insights...</div>`; },
            copyAIContent: function() { navigator.clipboard.writeText(document.getElementById('aiModalBody').innerText).then(() => alert("Copiado!")); },
            
            generateInsights: function(rate, defects, geo, mttf, modelStats) {
                const container = document.getElementById('insights-container');
                container.innerHTML = '';
                
                // --- FIX: Show insights even if Rate is empty (Sales missing) ---
                // If we have RMAs (Defects > 0), we can still show insights
                if(defects.length === 0 && rate.length === 0 && geo.length === 0) {
                     // Empty state handled by default HTML
                     return;
                }

                // 1. Volume
                let maxVolModel = null, maxVol = -1;
                for(const [m, s] of Object.entries(modelStats)) { if(s.rmas > maxVol){ maxVol=s.rmas; maxVolModel=m; } }
                if(maxVol > 0) container.innerHTML += this.createInsightHTML('purple', 'Maior Volume', maxVolModel, `Total: ${maxVol}`, 'model', maxVolModel);

                // 2. Taxa
                if(rate.length > 0 && rate[0].value > 0) {
                    container.innerHTML += this.createInsightHTML('critical', 'Maior Taxa', rate[0].label, `Taxa: ${rate[0].value.toFixed(2)}%`, 'model', rate[0].label);
                }
                // 3. Defeito
                if(defects.length > 0) {
                    container.innerHTML += this.createInsightHTML('warning', 'Defeito Comum', defects[0].label, `Ocorr√™ncias: ${defects[0].value}`, 'defect', defects[0].label);
                }
                // 4. Estado
                if(geo.length > 0) {
                    container.innerHTML += this.createInsightHTML('info', 'Maior Estado', geo[0].label, `Casos: ${geo[0].value}`, 'state', geo[0].label);
                }
            },
            
            createInsightHTML: function(type, title, mainText, subText, filterType, filterVal) {
                 if (filterType.endsWith('-stock')) {
                     return `
                    <div class="insight-item type-${type}" onclick="app.setStockTableFilter('${filterType.replace('-stock','')}', '${filterVal}')" title="Clique para filtrar">
                        <div class="insight-label">${title}</div>
                        <div class="insight-text">${mainText}</div>
                        <div class="insight-subtext">${subText}</div>
                    </div>`;
                 }
                 return `
                <div class="insight-item type-${type}" onclick="app.applyAnalyticsCrossFilter('${filterType}', '${filterVal}')" title="Clique para filtrar">
                    <div class="insight-label">${title}</div>
                    <div class="insight-text">${mainText}</div>
                    <div class="insight-subtext">${subText}</div>
                </div>`;
            }, 
            
            generateStockInsights: function(filtered, scheduledItems, sentCount) { /* ... Same ... */ },
            formatMTTF: function(days) { /* ... Same ... */ return days ? Math.round(days) + ' dias' : 'N/A'; },
            translateType: function(t) { const d={state:'Estado',model:'Modelo',defect:'Defeito',manuf:'Fabricante'}; return d[t]||t; },
            downloadTemplates: function() { /* ... Same ... */ }
        };

        function isValidDate(d) { return d instanceof Date && !isNaN(d); }

        app.init();
    </script>
</body>
</html>
