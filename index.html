<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics RMA | Inversores PV</title>
    <!-- SheetJS para ler Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Palette - Slate Theme */
            --bg-sidebar: #0f172a;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            
            --primary: #3b82f6; /* Blue 500 */
            --primary-hover: #2563eb; /* Blue 600 */
            
            --text-sidebar-main: #f8fafc;
            --text-sidebar-muted: #94a3b8;
            
            --text-main: #1e293b; /* Slate 800 */
            --text-muted: #64748b; /* Slate 500 */
            
            --border: #e2e8f0;
            --border-hover: #cbd5e1;
            
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --purple: #8b5cf6;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius: 0.5rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
        }

        /* Layout Grid */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100%;
            overflow: hidden;
        }

        /* Sidebar Styling */
        aside {
            background: var(--bg-sidebar);
            color: var(--text-sidebar-main);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            border-right: 1px solid #1e293b;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        h3 { 
            font-size: 0.75rem; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: var(--text-sidebar-muted); 
            margin-bottom: 12px; 
            margin-top: 4px;
        }

        .control-group { display: flex; flex-direction: column; gap: 10px; }
        
        /* Custom File Input */
        .file-drop-zone {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255,255,255,0.03);
            position: relative;
        }
        .file-drop-zone:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        .file-drop-zone input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-drop-icon { font-size: 24px; margin-bottom: 8px; display: block; opacity: 0.8; }
        .file-drop-text { font-size: 0.8rem; color: var(--text-sidebar-muted); }

        /* Inputs & Buttons Sidebar */
        input[type="date"] {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 10px;
            border-radius: var(--radius);
            width: 100%;
            font-family: inherit;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .checkbox-list {
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius);
            padding: 8px;
            background: rgba(0,0,0,0.2);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            font-size: 0.85rem;
            cursor: pointer;
            color: var(--text-sidebar-muted);
            border-radius: 4px;
            transition: background 0.2s;
        }
        .checkbox-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .checkbox-item input { margin-right: 10px; accent-color: var(--primary); }
        .checkbox-item input[type="radio"] { accent-color: var(--primary); }

        /* Buttons */
        .btn-ghost {
            background: transparent;
            color: var(--text-sidebar-muted);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.85rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-ghost:hover { border-color: var(--text-sidebar-muted); color: white; }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: background 0.2s;
        }
        .btn-primary:hover { background: var(--primary-hover); }

        .active-filter-indicator {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 10px;
            border-radius: var(--radius);
            font-size: 0.8rem;
            border: 1px solid rgba(59, 130, 246, 0.3);
            display: none;
            cursor: pointer;
            text-align: center;
        }
        .active-filter-indicator:hover { background: rgba(59, 130, 246, 0.3); }

        /* Scrollbar custom */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 10px; }
        aside ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); }

        /* Custom scrollbar for charts */
        .chart-body::-webkit-scrollbar { width: 6px; }
        .chart-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        .chart-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .chart-body::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Main Content */
        main {
            padding: 32px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .page-title { font-size: 1.5rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.025em; }
        .last-update { font-size: 0.85rem; color: var(--text-muted); }

        /* KPIs */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .kpi-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        
        .kpi-icon-wrapper {
            width: 40px; height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            font-size: 20px;
        }
        .bg-blue-light { background: #eff6ff; color: var(--primary); }
        .bg-red-light { background: #fef2f2; color: var(--danger); }
        .bg-green-light { background: #ecfdf5; color: var(--success); }
        .bg-orange-light { background: #fffbeb; color: var(--warning); }

        .kpi-title { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: var(--text-main); margin-top: 4px; letter-spacing: -0.03em; }

        /* Insights */
        .insights-section {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }
        .insights-header { font-size: 1rem; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
        
        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
        
        .insight-item {
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: transform 0.2s, box-shadow 0.2s; /* AnimaÃ§Ã£o */
        }
        
        /* Interatividade no Hover */
        .insight-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            filter: brightness(0.98);
        }

        .insight-item.critical { border-color: #fca5a5; background: #fef2f2; }
        .insight-item.warning { border-color: #fcd34d; background: #fffbeb; }
        .insight-item.info { border-color: #93c5fd; background: #eff6ff; }
        .insight-item.purple { border-color: #c4b5fd; background: #f5f3ff; }
        
        .insight-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8; }
        .insight-item.critical .insight-label { color: #991b1b; }
        .insight-item.warning .insight-label { color: #92400e; }
        .insight-item.info .insight-label { color: #1e40af; }
        .insight-item.purple .insight-label { color: #5b21b6; }

        .insight-text { font-size: 0.9rem; color: var(--text-main); font-weight: 500; line-height: 1.4; }
        .insight-highlight { font-weight: 700; }
        .insight-subtext { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
        .insight-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; opacity: 0; transition: opacity 0.2s; text-align: right; }
        .insight-item:hover .insight-hint { opacity: 1; }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            height: 420px;
        }
        .chart-header { margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .chart-header h3 { color: var(--text-main); font-size: 1rem; margin: 0; text-transform: none; letter-spacing: -0.01em; }

        .chart-body {
            flex-grow: 1;
            overflow-y: auto; 
            padding-right: 8px;
        }

        /* --- Novo Estilo de Barras (Stacked) --- */
        .bar-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }
        .bar-row:hover { background: #f8fafc; border-radius: 4px; }
        .bar-row:last-child { border-bottom: none; }
        
        .bar-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            width: 100%;
        }

        .bar-label {
            font-size: 0.85rem;
            color: var(--text-main);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        .bar-value-text {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
            text-align: right;
        }
        
        .value-highlight {
            color: var(--primary);
            font-weight: 700;
        }
        
        .bar-track {
            width: 100%;
            background: #f1f5f9;
            height: 10px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .app-container { grid-template-columns: 1fr; overflow-y: auto; }
            aside { border-right: none; border-bottom: 1px solid var(--border); }
            .charts-grid { grid-template-columns: 1fr; }
            body { overflow: auto; height: auto; }
        }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(4px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s ease-in-out infinite; margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Overlay de Carregamento -->
    <div id="loader" style="display:none;">
        <div class="spinner"></div>
        <div style="font-weight:600; color:var(--text-muted);">Processando dados...</div>
    </div>

    <div class="app-container">
        <!-- Sidebar Dark Mode -->
        <aside>
            <div class="brand">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                Analytics RMA
            </div>
            
            <div class="control-group">
                <h3>Dados de Entrada</h3>
                <div class="file-drop-zone">
                    <span class="file-drop-icon">ðŸ“‚</span>
                    <div class="file-drop-text">Arraste ou clique para selecionar<br><b>os 3 arquivos Excel</b></div>
                    <input type="file" id="fileInput" multiple accept=".xlsx, .xls">
                </div>
                <div id="file-status" style="font-size: 0.75rem; color: var(--success); text-align: center; margin-top:-5px; min-height: 16px;"></div>
                
                <button class="btn-ghost" onclick="app.downloadTemplates()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Baixar Modelos
                </button>
            </div>

            <div class="active-filter-indicator" id="crossFilterIndicator" onclick="app.clearCrossFilter()">
                Filtro Ativo: <strong id="crossFilterText"></strong>
                <div style="font-size: 0.7em; margin-top:4px; opacity:0.8;">Clique para limpar</div>
            </div>

            <div class="control-group">
                <h3>PerÃ­odo</h3>
                <input type="date" id="dateStart" onchange="app.render()">
                <input type="date" id="dateEnd" onchange="app.render()">
            </div>
            
            <!-- Novo Filtro de Estoque -->
            <div class="control-group">
                <h3>Status de Estoque</h3>
                <div style="display: flex; gap: 8px; flex-direction: column;">
                    <label class="checkbox-item">
                        <input type="radio" name="stockFilter" value="all" checked onchange="app.setStockFilter('all')"> 
                        Todos
                    </label>
                    <label class="checkbox-item">
                        <input type="radio" name="stockFilter" value="Sim" onchange="app.setStockFilter('Sim')"> 
                        Em Estoque (Sim)
                    </label>
                    <label class="checkbox-item">
                        <input type="radio" name="stockFilter" value="NÃ£o" onchange="app.setStockFilter('NÃ£o')"> 
                        Fora de Estoque (NÃ£o)
                    </label>
                </div>
            </div>

            <div class="control-group">
                <h3>Fabricante</h3>
                <div class="checkbox-list" id="filter-manufacturers">
                    <!-- Dinamicamente preenchido -->
                    <div style="padding:10px; text-align:center; color: var(--text-sidebar-muted); font-size:0.8rem;">Carregue arquivos para filtrar</div>
                </div>
            </div>

            <div class="control-group">
                <h3>Modelo</h3>
                <div class="checkbox-list" id="filter-models">
                    <div style="padding:10px; text-align:center; color: var(--text-sidebar-muted); font-size:0.8rem;">---</div>
                </div>
            </div>

            <div style="margin-top: auto;">
                <button class="btn-primary" onclick="app.resetFilters()">Limpar Filtros</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main>
            <div class="section-header">
                <div>
                    <h1 class="page-title">Dashboard Geral</h1>
                    <div class="last-update" id="last-update-text">Aguardando dados...</div>
                </div>
            </div>

            <!-- KPIs -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon-wrapper bg-blue-light">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div class="kpi-title">Total de Vendas</div>
                    <div class="kpi-value" id="kpi-sales">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon-wrapper bg-orange-light">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                    </div>
                    <div class="kpi-title">Total de RMAs</div>
                    <div class="kpi-value" id="kpi-rmas">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon-wrapper bg-red-light">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    </div>
                    <div class="kpi-title">Taxa de Falha</div>
                    <div class="kpi-value" id="kpi-rate">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon-wrapper bg-green-light">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
                    </div>
                    <div class="kpi-title">Estados Afetados</div>
                    <div class="kpi-value" id="kpi-states">-</div>
                </div>
            </div>

            <!-- Insights AutomÃ¡ticos -->
            <div class="insights-section">
                <div class="insights-header">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                    Insights Inteligentes
                </div>
                <div class="insights-grid" id="insights-container">
                    <div class="insight-item info">
                        <div class="insight-label">Info</div>
                        <div class="insight-text">Carregue os arquivos para visualizar as anÃ¡lises.</div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Taxa de Falha por Modelo (%)</h3>
                    </div>
                    <div class="chart-body" id="chart-rate-model"></div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Top 10 Defeitos Recorrentes</h3>
                    </div>
                    <div class="chart-body" id="chart-defects"></div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>DistribuiÃ§Ã£o Regional (Estados)</h3>
                    </div>
                    <div class="chart-body" id="chart-geo"></div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>MTTF (Tempo MÃ©dio atÃ© Falha)</h3>
                    </div>
                    <div class="chart-body" id="chart-mttf"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const app = {
            data: { sales: [], rmas: [], mttf: [] },
            mapping: { productToManuf: {}, productToStock: {} }, // ADICIONADO: productToStock
            filters: { manufacturers: new Set(), models: new Set(), dateStart: null, dateEnd: null, crossFilter: null, stockStatus: 'all' },

            init: function() {
                document.getElementById('fileInput').addEventListener('change', this.handleFileUpload.bind(this));
            },

            handleFileUpload: async function(e) {
                const files = e.target.files;
                if (files.length === 0) return;

                this.toggleLoader(true);
                const promises = Array.from(files).map(file => this.readFile(file));
                
                try {
                    const results = await Promise.all(promises);
                    this.processFiles(results);
                    this.buildFiltersUI();
                    this.render();
                    document.getElementById('file-status').innerText = `${files.length} arquivos prontos`;
                    document.getElementById('last-update-text').innerText = "Dados atualizados em: " + new Date().toLocaleTimeString();
                } catch (err) {
                    alert("Erro ao processar: " + err.message);
                } finally {
                    this.toggleLoader(false);
                }
            },

            readFile: function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                            const firstSheetName = workbook.SheetNames[0];
                            const json = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);
                            resolve({ name: file.name, data: json });
                        } catch (err) { reject(err); }
                    };
                    reader.readAsArrayBuffer(file);
                });
            },

            processFiles: function(results) {
                this.data = { sales: [], rmas: [], mttf: [] };
                this.mapping.productToManuf = {};
                this.mapping.productToStock = {}; // Reiniciar mapa

                results.forEach(res => {
                    const keys = Object.keys(res.data[0] || {}).map(k => k.trim());
                    if (keys.includes("Total Vendido") && keys.includes("Quant. de SAC")) {
                        this.data.sales = res.data;
                    } else if (keys.includes("ProblemÃ¡tica") && keys.includes("Data de CriaÃ§Ã£o")) {
                        this.data.rmas = res.data.map(row => ({
                            ...row,
                            "Data de CriaÃ§Ã£o": row["Data de CriaÃ§Ã£o"] instanceof Date ? row["Data de CriaÃ§Ã£o"] : new Date(row["Data de CriaÃ§Ã£o"])
                        }));
                    } else if (keys.includes("MÃ©dia de MTTF")) {
                        this.data.mttf = res.data;
                    }
                });

                if (!this.data.sales.length && !this.data.rmas.length) {
                    alert("Arquivos nÃ£o identificados. Verifique colunas.");
                    return;
                }

                // Cruzar informaÃ§Ãµes e preencher mapa de estoque
                // AGORA INCLUINDO SALES NO LOOP DE ESTOQUE
                const allRows = [...this.data.sales, ...this.data.rmas];
                allRows.forEach(row => {
                    if (row["Produto"]) {
                        if (row["Fabricante"]) this.mapping.productToManuf[row["Produto"]] = row["Fabricante"];
                        
                        // Captura status do estoque se disponÃ­vel
                        if (row["Ativo"]) {
                            this.mapping.productToStock[row["Produto"]] = row["Ativo"].toString().trim();
                        }
                    }
                });

                this.data.mttf.forEach(row => {
                    if (!row["Fabricante"] && row["Produto"]) row["Fabricante"] = this.mapping.productToManuf[row["Produto"]] || "Desconhecido";
                });

                if (this.data.rmas.length > 0) {
                    const dates = this.data.rmas.map(r => r["Data de CriaÃ§Ã£o"]).filter(d => !isNaN(d));
                    if (dates.length) {
                        const minDate = new Date(Math.min.apply(null, dates));
                        const maxDate = new Date(Math.max.apply(null, dates));
                        document.getElementById('dateStart').value = minDate.toISOString().split('T')[0];
                        document.getElementById('dateEnd').value = maxDate.toISOString().split('T')[0];
                    }
                }
            },

            buildFiltersUI: function() {
                const manufacturers = new Set();
                const models = new Set();
                [this.data.sales, this.data.rmas].forEach(source => {
                    source.forEach(row => {
                        if (row["Fabricante"]) manufacturers.add(row["Fabricante"]);
                        if (row["Produto"]) models.add(row["Produto"]);
                    });
                });

                const manufContainer = document.getElementById('filter-manufacturers');
                manufContainer.innerHTML = '';
                Array.from(manufacturers).sort().forEach(m => {
                    manufContainer.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="filter-checkbox" data-group="manuf" value="${m}">${m}</label>`;
                });

                const modelContainer = document.getElementById('filter-models');
                modelContainer.innerHTML = '';
                Array.from(models).sort().forEach(m => {
                    modelContainer.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="filter-checkbox" data-group="model" value="${m}">${m}</label>`;
                });

                document.querySelectorAll('.filter-checkbox').forEach(cb => cb.addEventListener('change', () => this.render()));
            },

            getFilteredData: function() {
                const dateStartStr = document.getElementById('dateStart').value;
                const dateEndStr = document.getElementById('dateEnd').value;
                const dateStart = dateStartStr ? new Date(dateStartStr) : null;
                const dateEnd = dateEndStr ? new Date(dateEndStr) : null;
                if(dateEnd) dateEnd.setHours(23,59,59);

                const selectedManuf = Array.from(document.querySelectorAll('input[data-group="manuf"]:checked')).map(c => c.value);
                const selectedModels = Array.from(document.querySelectorAll('input[data-group="model"]:checked')).map(c => c.value);

                // Helper de checagem comum
                const passCommon = (row) => {
                    if (selectedManuf.length > 0 && !selectedManuf.includes(row["Fabricante"])) return false;
                    if (selectedModels.length > 0 && !selectedModels.includes(row["Produto"])) return false;
                    if (this.filters.crossFilter) {
                        const { type, value } = this.filters.crossFilter;
                        if (type === 'state' && row["Estado"] !== value) return false;
                        if (type === 'model' && row["Produto"] !== value) return false;
                        if (type === 'defect' && row["ProblemÃ¡tica"] !== value) return false;
                    }
                    return true;
                };

                // Filtra Sales (Agora aplica filtro de estoque via coluna direta ou mapa)
                const filteredSales = this.data.sales.filter(row => {
                    if (!passCommon(row)) return false;
                    
                    if (this.filters.stockStatus !== 'all') {
                        // Prioriza a coluna da prÃ³pria linha, depois o mapa
                        let status = (row["Ativo"] || this.mapping.productToStock[row["Produto"]] || "").toString().trim().toLowerCase();
                        if (status !== this.filters.stockStatus.toLowerCase()) return false;
                    }
                    return true;
                });

                // Filtra RMAs
                const filteredRmas = this.data.rmas.filter(row => {
                    // 1. Data
                    if (dateStart && row["Data de CriaÃ§Ã£o"] < dateStart) return false;
                    if (dateEnd && row["Data de CriaÃ§Ã£o"] > dateEnd) return false;
                    
                    // 2. Filtro de Estoque
                    if (this.filters.stockStatus !== 'all') {
                        let status = (row["Ativo"] || this.mapping.productToStock[row["Produto"]] || "").toString().trim().toLowerCase();
                        if (status !== this.filters.stockStatus.toLowerCase()) return false;
                    }
                    
                    // 3. Comuns
                    return passCommon(row);
                });

                // Filtra MTTF
                const filteredMttf = this.data.mttf.filter(row => {
                   if (!passCommon(row)) return false; 
                   
                   if (this.filters.stockStatus !== 'all') {
                       // MTTF nÃ£o tem coluna Ativo, depende puramente do Mapa
                       let status = (this.mapping.productToStock[row["Produto"]] || "").toString().trim().toLowerCase();
                       if (status !== this.filters.stockStatus.toLowerCase()) return false;
                   }
                   return true;
                });

                return { sales: filteredSales, rmas: filteredRmas, mttf: filteredMttf };
            },

            setStockFilter: function(val) {
                this.filters.stockStatus = val;
                this.render();
            },

            render: function() {
                const data = this.getFilteredData();
                const totalSales = data.sales.reduce((acc, curr) => acc + (parseFloat(curr["Total Vendido"]) || 0), 0);
                const totalRmas = data.rmas.length; 
                const rate = totalSales > 0 ? ((totalRmas / totalSales) * 100).toFixed(2) : "0.00";
                const uniqueStates = new Set(data.rmas.map(r => r["Estado"]).filter(x=>x)).size;

                document.getElementById('kpi-sales').innerText = totalSales.toLocaleString('pt-BR');
                document.getElementById('kpi-rmas').innerText = totalRmas.toLocaleString('pt-BR');
                document.getElementById('kpi-rate').innerText = rate + "%";
                document.getElementById('kpi-states').innerText = uniqueStates;

                const modelStats = {};
                data.sales.forEach(s => { modelStats[s["Produto"]] = { sales: (s["Total Vendido"] || 0), rmas: 0 }; });
                data.rmas.forEach(r => {
                    if (modelStats[r["Produto"]]) modelStats[r["Produto"]].rmas++;
                    else if (!data.sales.length) modelStats[r["Produto"]] = { sales: 1, rmas: 1 };
                });

                const chartDataRate = Object.entries(modelStats)
                    .map(([model, stats]) => {
                        const pct = stats.sales > 0 ? ((stats.rmas / stats.sales) * 100).toFixed(2) : "0.00";
                        return {
                            label: model,
                            value: stats.sales > 0 ? (stats.rmas / stats.sales) * 100 : 0,
                            displayHtml: `<span class="value-highlight">${pct}%</span> <span style="font-size:0.8em; color:var(--text-muted); font-weight:400;">(${stats.rmas} Flh / ${stats.sales} Vnd)</span>`,
                            raw: model
                        };
                    })
                    .sort((a, b) => b.value - a.value);

                const defectsCount = {};
                data.rmas.forEach(r => {
                    const defect = r["ProblemÃ¡tica"] || "Outros";
                    defectsCount[defect] = (defectsCount[defect] || 0) + 1;
                });
                const chartDataDefects = Object.entries(defectsCount)
                    .map(([d, count]) => {
                        // Calcula a porcentagem em relaÃ§Ã£o ao total de RMAs
                        const pct = totalRmas > 0 ? ((count / totalRmas) * 100).toFixed(2) : "0.00";
                        return { 
                            label: d, 
                            value: count, 
                            displayHtml: `<span class="value-highlight">${count}</span> <span style="font-size:0.8em; color:var(--text-muted); font-weight:400;">(${pct}%)</span>`,
                            raw: d 
                        };
                    })
                    .sort((a, b) => b.value - a.value).slice(0, 10); 

                const stateCount = {};
                data.rmas.forEach(r => {
                    const state = r["Estado"] || "N/A";
                    stateCount[state] = (stateCount[state] || 0) + 1;
                });
                const chartDataGeo = Object.entries(stateCount)
                    .map(([s, count]) => ({ 
                        label: s, 
                        value: count, 
                        displayHtml: `<span class="value-highlight">${count}</span>`,
                        raw: s 
                    }))
                    .sort((a, b) => b.value - a.value);

                const chartDataMttf = data.mttf
                    .map(r => ({
                        label: r["Produto"],
                        value: parseFloat(r["MÃ©dia de MTTF"]),
                        displayHtml: `<span class="value-highlight">${this.formatMTTF(r["MÃ©dia de MTTF"])}</span>`,
                        raw: r["Produto"]
                    }))
                    .sort((a, b) => a.value - b.value);

                this.drawChart('chart-rate-model', chartDataRate, 'model');
                this.drawChart('chart-defects', chartDataDefects, 'defect');
                this.drawChart('chart-geo', chartDataGeo, 'state');
                this.drawChart('chart-mttf', chartDataMttf, 'model');
                
                const indicator = document.getElementById('crossFilterIndicator');
                if (this.filters.crossFilter) {
                    indicator.style.display = 'block';
                    document.getElementById('crossFilterText').innerText = 
                        `${this.translateType(this.filters.crossFilter.type)}: ${this.filters.crossFilter.value}`;
                } else {
                    indicator.style.display = 'none';
                }

                // Passando modelStats tambÃ©m para calcular volume absoluto
                this.generateInsights(chartDataRate, chartDataDefects, chartDataGeo, chartDataMttf, modelStats);
            },

            drawChart: function(containerId, data, filterType) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                if (data.length === 0) {
                    container.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:40px 0; font-size:0.9rem;">Sem dados para exibir</div>';
                    return;
                }
                const maxValue = Math.max(...data.map(d => d.value));

                data.forEach(item => {
                    const percent = maxValue > 0 ? (item.value / maxValue) * 100 : 0;
                    const row = document.createElement('div');
                    row.className = 'bar-row';
                    row.onclick = () => this.applyCrossFilter(filterType, item.raw);
                    
                    // Novo Layout Empilhado
                    row.innerHTML = `
                        <div class="bar-header">
                            <div class="bar-label" title="${item.label}">${item.label}</div>
                            <div class="bar-value-text">${item.displayHtml}</div>
                        </div>
                        <div class="bar-track">
                            <div class="bar-fill" style="width: ${percent}%;"></div>
                        </div>
                    `;
                    container.appendChild(row);
                });
            },

            generateInsights: function(rateData, defectData, geoData, mttfData, modelStats) {
                const container = document.getElementById('insights-container');
                container.innerHTML = '';

                if (rateData.length === 0) {
                    container.innerHTML = `<div class="insight-item info"><div class="insight-text">Aguardando dados...</div></div>`;
                    return;
                }

                // 1. Maior Volume de RMA (Quantidade)
                let maxRmaModel = null;
                let maxRmaCount = -1;
                for (const [model, stats] of Object.entries(modelStats)) {
                    if (stats.rmas > maxRmaCount) {
                        maxRmaCount = stats.rmas;
                        maxRmaModel = model;
                    }
                }
                
                if (maxRmaModel && maxRmaCount > 0) {
                     container.innerHTML += `
                        <div class="insight-item purple" onclick="app.applyCrossFilter('model', '${maxRmaModel}')" title="Clique para filtrar por este modelo">
                            <div class="insight-label">Maior Volume de RMA</div>
                            <div class="insight-text">O modelo <span class="insight-highlight">${maxRmaModel}</span> lidera em nÃºmeros absolutos.</div>
                            <div class="insight-subtext">Total: <b>${maxRmaCount}</b> unidades em garantia.</div>
                            <div class="insight-hint">Clique para filtrar â†’</div>
                        </div>`;
                }

                // 2. Maior Taxa de Falhas (Porcentagem + Qtd Vendida)
                if (rateData.length > 0 && rateData[0].value > 0) {
                    const modelName = rateData[0].label;
                    const stats = modelStats[modelName] || { sales: 0 };
                    
                    container.innerHTML += `
                        <div class="insight-item critical" onclick="app.applyCrossFilter('model', '${modelName}')" title="Clique para filtrar por este modelo">
                            <div class="insight-label">Maior Taxa de Falha</div>
                            <div class="insight-text">O modelo <span class="insight-highlight">${modelName}</span> possui taxa de <span class="insight-highlight">${rateData[0].value.toFixed(2)}%</span>.</div>
                            <div class="insight-subtext">Vendas: ${stats.sales} un.</div>
                            <div class="insight-hint">Clique para filtrar â†’</div>
                        </div>`;
                }

                // 3. Defeito Mais Comum (Quantidade)
                if (defectData.length > 0) {
                    container.innerHTML += `
                        <div class="insight-item warning" onclick="app.applyCrossFilter('defect', '${defectData[0].label}')" title="Clique para filtrar por este defeito">
                            <div class="insight-label">Defeito Mais Comum</div>
                            <div class="insight-text">"<span class="insight-highlight">${defectData[0].label}</span>" Ã© a causa principal.</div>
                            <div class="insight-subtext">OcorrÃªncias: <b>${defectData[0].value}</b> vezes.</div>
                            <div class="insight-hint">Clique para filtrar â†’</div>
                        </div>`;
                }

                // 4. Estado com Maior Volume (Quantidade)
                if (geoData.length > 0) {
                    container.innerHTML += `
                        <div class="insight-item info" onclick="app.applyCrossFilter('state', '${geoData[0].label}')" title="Clique para filtrar por este estado">
                            <div class="insight-label">Estado Mais Afetado</div>
                            <div class="insight-text">O estado <span class="insight-highlight">${geoData[0].label}</span> concentra a maior demanda.</div>
                            <div class="insight-subtext">Total de casos: <b>${geoData[0].value}</b>.</div>
                            <div class="insight-hint">Clique para filtrar â†’</div>
                        </div>`;
                }
                
                // 5. Menor Vida Ãštil (MTTF + Qtd Garantia)
                if (mttfData.length > 0) {
                    const worstModel = mttfData[0];
                    const rmaCount = modelStats[worstModel.raw] ? modelStats[worstModel.raw].rmas : 0;
                    
                    container.innerHTML += `
                        <div class="insight-item critical" onclick="app.applyCrossFilter('model', '${worstModel.raw}')" title="Clique para filtrar por este modelo">
                            <div class="insight-label">Menor Vida Ãštil (MTTF)</div>
                            <div class="insight-text"><span class="insight-highlight">${worstModel.label}</span> quebra mais rÃ¡pido.</div>
                            <div class="insight-subtext">Tempo MÃ©dio: <b>${worstModel.displayHtml.replace(/<[^>]*>?/gm, '')}</b> (Base: ${rmaCount} falhas).</div>
                            <div class="insight-hint">Clique para filtrar â†’</div>
                        </div>`;
                }
            },

            formatMTTF: function(days) {
                if (!days) return "N/A";
                const years = Math.floor(days / 365);
                const months = Math.floor((days % 365) / 30);
                if (years > 0) return `${years}a ${months}m`;
                if (months > 0) return `${months} meses`;
                return `${Math.round(days)} dias`;
            },
            applyCrossFilter: function(type, value) { this.filters.crossFilter = { type, value }; this.render(); },
            clearCrossFilter: function() { this.filters.crossFilter = null; this.render(); },
            resetFilters: function() {
                document.getElementById('dateStart').value = '';
                document.getElementById('dateEnd').value = '';
                
                // Reset stock filter
                this.filters.stockStatus = 'all';
                const stockRadios = document.getElementsByName('stockFilter');
                if(stockRadios.length) stockRadios[0].checked = true;

                document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
                this.filters.crossFilter = null;
                this.render();
            },
            translateType: function(type) { const dict = { 'state': 'Estado', 'model': 'Modelo', 'defect': 'Defeito' }; return dict[type] || type; },
            toggleLoader: function(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; },
            
            downloadTemplates: function() {
                // ATUALIZADO: Incluindo coluna "Ativo" tambÃ©m em Vendas
                const dataSales = [
                    { "Produto": "Modelo A-1000", "Fabricante": "SolarTech", "Quant. de SAC": 5, "Total Vendido": 200, "Ativo": "Sim" },
                    { "Produto": "Modelo B-2000", "Fabricante": "EcoPower", "Quant. de SAC": 12, "Total Vendido": 500, "Ativo": "NÃ£o" }
                ];
                // ATUALIZADO: Incluindo coluna "Ativo"
                const dataRMA = [
                    { "Produto": "Modelo A-1000", "Fabricante": "SolarTech", "ProblemÃ¡tica": "Falha Display", "Estado": "SP", "Data de CriaÃ§Ã£o": new Date("2023-01-15"), "Ativo": "Sim" },
                    { "Produto": "Modelo B-2000", "Fabricante": "EcoPower", "ProblemÃ¡tica": "Erro Grid", "Estado": "MG", "Data de CriaÃ§Ã£o": new Date("2023-02-20"), "Ativo": "NÃ£o" }
                ];
                const dataMTTF = [
                    { "Produto": "Modelo A-1000", "MÃ©dia de MTTF": 450 },
                    { "Produto": "Modelo B-2000", "MÃ©dia de MTTF": 320 }
                ];
                const saveSheet = (data, fileName) => {
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Dados");
                    XLSX.writeFile(wb, fileName);
                };
                saveSheet(dataSales, "RMA_por_Vendas.xlsx");
                setTimeout(() => saveSheet(dataRMA, "Total_RMA.xlsx"), 1000);
                setTimeout(() => saveSheet(dataMTTF, "MTTF.xlsx"), 2000);
            }
        };
        app.init();
    </script>
</body>
</html>
